version: "3.8"

services:
    # Prometheus
    prometheus:
        image: prom/prometheus:v2.54.1
        container_name: rakuten_prometheus
        command:
            - "--config.file=/etc/prometheus/prometheus.yml"
            - "--storage.tsdb.path=/prometheus"
            - "--storage.tsdb.retention.time=${PROMETHEUS_RETENTION:-30d}"
            - "--web.console.libraries=/usr/share/prometheus/console_libraries"
            - "--web.console.templates=/usr/share/prometheus/consoles"
        volumes:
            - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
            - prometheus_data:/prometheus
        ports:
            - "${PROMETHEUS_PORT:-9090}:9090"
        restart: unless-stopped
        healthcheck:
            test: ["CMD", "wget", "--spider", "-q", "http://localhost:9090/-/healthy"]
            interval: 30s
            timeout: 10s
            retries: 3
        networks:
            - rakuten_monitor_network
        extra_hosts:
            - "host.docker.internal:host-gateway"  # Allow scraping localhost services

    # Grafana
    grafana:
        image: grafana/grafana:11.4.0
        container_name: rakuten_grafana
        environment:
            # Admin credentials
            GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
            GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin}

            # Server settings
            GF_SERVER_ROOT_URL: http://localhost:${GRAFANA_PORT:-3000}
            GF_USERS_ALLOW_SIGN_UP: ${GF_USERS_ALLOW_SIGN_UP:-false}

            # Anonymous access (for embedding)
            GF_AUTH_ANONYMOUS_ENABLED: true
            GF_AUTH_ANONYMOUS_ORG_ROLE: Viewer

            # Paths
            GF_PATHS_PROVISIONING: /etc/grafana/provisioning
            GF_PATHS_DATA: /var/lib/grafana
        volumes:
            - ./grafana/provisioning:/etc/grafana/provisioning
            - grafana_data:/var/lib/grafana
        ports:
            - "${GRAFANA_PORT:-3000}:3000"
        depends_on:
            - prometheus
        restart: unless-stopped
        healthcheck:
            test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/api/health"]
            interval: 30s
            timeout: 10s
            retries: 3
        networks:
            - rakuten_monitor_network

networks:
    rakuten_monitor_network:
        driver: bridge

volumes:
    prometheus_data:
    grafana_data:
