version: "3.8"

services:
    # PostgreSQL Database (shared with infrastructure)
    postgres:
        image: postgres:15-alpine
        container_name: rakuten_postgres_api
        environment:
            POSTGRES_USER: ${POSTGRES_USER:-rakuten_user}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-rakuten_pass}
            POSTGRES_DB: ${POSTGRES_DB:-rakuten_db}
        volumes:
            - postgres_data_api:/var/lib/postgresql/data
        ports:
            - "5432:5432"
        healthcheck:
            test:
                [
                    "CMD-SHELL",
                    "pg_isready -U ${POSTGRES_USER:-rakuten_user} -d ${POSTGRES_DB:-rakuten_db}",
                ]
            interval: 10s
            timeout: 5s
            retries: 5
        networks:
            - rakuten_api_network

    # MinIO (shared with infrastructure)
    minio:
        image: minio/minio:RELEASE.2024-06-13T22-53-53Z
        container_name: rakuten_minio_api
        environment:
            MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minio_admin}
            MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minio_password}
        volumes:
            - minio_data_api:/data
        ports:
            - "9000:9000"
            - "9001:9001"
        command: server /data --console-address ":9001"
        healthcheck:
            test: ["CMD", "mc", "ready", "local"]
            interval: 10s
            timeout: 5s
            retries: 5
        networks:
            - rakuten_api_network

    # MinIO Bucket Initialization
    minio-init:
        image: minio/mc:RELEASE.2024-06-12T14-34-03Z
        container_name: rakuten_minio_init_api
        depends_on:
            minio:
                condition: service_healthy
        entrypoint: >
            /bin/sh -c "
            mc alias set myminio http://minio:9000 $${MINIO_ROOT_USER:-minio_admin} $${MINIO_ROOT_PASSWORD:-minio_password};
            mc mb myminio/mlflow-artifacts --ignore-existing;
            echo 'Buckets created successfully';
            exit 0;
            "
        environment:
            MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minio_admin}
            MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minio_password}
        networks:
            - rakuten_api_network

    # MLflow Tracking Server
    mlflow:
        image: ghcr.io/mlflow/mlflow:v2.10.0
        container_name: rakuten_mlflow_api
        environment:
            MLFLOW_BACKEND_STORE_URI: postgresql://${POSTGRES_USER:-rakuten_user}:${POSTGRES_PASSWORD:-rakuten_pass}@postgres:5432/mlflow_db
            MLFLOW_S3_ENDPOINT_URL: http://minio:9000
            AWS_ACCESS_KEY_ID: ${MINIO_ROOT_USER:-minio_admin}
            AWS_SECRET_ACCESS_KEY: ${MINIO_ROOT_PASSWORD:-minio_password}
        ports:
            - "5000:5000"
        command: >
            bash -c "pip install boto3 psycopg2-binary &&
            mlflow server
            --backend-store-uri postgresql://${POSTGRES_USER:-rakuten_user}:${POSTGRES_PASSWORD:-rakuten_pass}@postgres:5432/mlflow_db
            --default-artifact-root s3://mlflow-artifacts
            --host 0.0.0.0
            --port 5000"
        depends_on:
            postgres:
                condition: service_healthy
            minio-init:
                condition: service_completed_successfully
        healthcheck:
            test:
                [
                    "CMD-SHELL",
                    'python3 -c "import urllib.request; urllib.request.urlopen(''http://localhost:5000/health'')"',
                ]
            interval: 15s
            timeout: 5s
            retries: 10
            start_period: 30s
        networks:
            - rakuten_api_network

    # FastAPI Service
    api:
        build:
            context: .
            dockerfile: src/serve/Dockerfile
        container_name: rakuten_api
        environment:
            # MLflow
            MLFLOW_TRACKING_URI: http://mlflow:5000
            MLFLOW_S3_ENDPOINT_URL: http://minio:9000
            AWS_ACCESS_KEY_ID: ${MINIO_ROOT_USER:-minio_admin}
            AWS_SECRET_ACCESS_KEY: ${MINIO_ROOT_PASSWORD:-minio_password}

            # Model Configuration
            MODEL_NAME: ${MODEL_NAME:-rakuten_classifier}
            MODEL_STAGE: ${MODEL_STAGE:-Production}
            MODEL_RELOAD_INTERVAL: ${MODEL_RELOAD_INTERVAL:-300}

            # API Configuration
            API_HOST: ${API_HOST:-0.0.0.0}
            API_PORT: ${API_PORT:-8000}
            API_WORKERS: ${API_WORKERS:-2}

            # Inference Logging
            INFERENCE_LOG_PATH: ${INFERENCE_LOG_PATH:-/app/data/monitoring/inference_log.csv}
            INFERENCE_LOG_MAX_ROWS: ${INFERENCE_LOG_MAX_ROWS:-100000}

            # PostgreSQL (optional, for querying dataset stats)
            POSTGRES_HOST: postgres
            POSTGRES_PORT: 5432
            POSTGRES_DB: ${POSTGRES_DB:-rakuten_db}
            POSTGRES_USER: ${POSTGRES_USER:-rakuten_user}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-rakuten_pass}
        volumes:
            - ./data/monitoring:/app/data/monitoring
            - ./src:/app/src  # For development hot-reload
        ports:
            - "8000:8000"
        depends_on:
            mlflow:
                condition: service_healthy
        healthcheck:
            test:
                [
                    "CMD-SHELL",
                    'python -c "import urllib.request; urllib.request.urlopen(''http://localhost:8000/health'')"',
                ]
            interval: 30s
            timeout: 10s
            retries: 5
            start_period: 45s
        networks:
            - rakuten_api_network

networks:
    rakuten_api_network:
        driver: bridge

volumes:
    postgres_data_api:
    minio_data_api:
