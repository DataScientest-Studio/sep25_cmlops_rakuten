#version: "3.8"

services:
    # PostgreSQL Database
    postgres:
        image: postgres:15-alpine
        container_name: rakuten_postgres
        environment:
            POSTGRES_USER: ${POSTGRES_USER:-rakuten_user}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-rakuten_pass}
            POSTGRES_DB: ${POSTGRES_DB:-rakuten_db}
        volumes:
            - postgres_data:/var/lib/postgresql/data
            - ./src/data/init-db.sh:/docker-entrypoint-initdb.d/01-init-db.sh
            - ./src/data/schema.sql:/docker-entrypoint-initdb.d/02-schema.sql
        ports:
            - "5432:5432"
        healthcheck:
            test:
                [
                    "CMD-SHELL",
                    "pg_isready -U ${POSTGRES_USER:-rakuten_user} -d ${POSTGRES_DB:-rakuten_db}",
                ]
            interval: 10s
            timeout: 5s
            retries: 5
        networks:
            - rakuten_network

    # MinIO
    minio:
        image: minio/minio:RELEASE.2024-06-13T22-53-53Z
        container_name: rakuten_minio
        environment:
            MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minio_admin}
            MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minio_password}
        volumes:
            - minio_data:/data
        ports:
            - "9000:9000" # API S3
            - "9001:9001" # Console Web UI
        command: server /data --console-address ":9001"
        healthcheck:
            test:
                ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
            interval: 10s
            timeout: 5s
            retries: 5
        networks:
            - rakuten_network

    # MinIO Bucket Initialization
    minio-init:
        image: minio/mc:RELEASE.2024-06-12T14-34-03Z
        container_name: rakuten_minio_init
        depends_on:
            minio:
                condition: service_healthy
        entrypoint: >
            /bin/sh -c "
            mc alias set myminio http://minio:9000 $${MINIO_ROOT_USER:-minio_admin} $${MINIO_ROOT_PASSWORD:-minio_password};
            mc mb myminio/landing --ignore-existing;
            mc mb myminio/dvc-storage --ignore-existing;
            mc mb myminio/mlflow-artifacts --ignore-existing;
            echo 'Buckets created successfully';
            exit 0;
            "
        environment:
            MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minio_admin}
            MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minio_password}
        networks:
            - rakuten_network

    # MLflow Tracking Server
    mlflow:
        image: ghcr.io/mlflow/mlflow:v2.10.0
        container_name: rakuten_mlflow
        environment:
            MLFLOW_BACKEND_STORE_URI: postgresql://${POSTGRES_USER:-rakuten_user}:${POSTGRES_PASSWORD:-rakuten_pass}@postgres:5432/mlflow_db
            MLFLOW_S3_ENDPOINT_URL: http://minio:9000
            AWS_ACCESS_KEY_ID: ${MINIO_ROOT_USER:-minio_admin}
            AWS_SECRET_ACCESS_KEY: ${MINIO_ROOT_PASSWORD:-minio_password}
        ports:
            - "5000:5000"
        command: >
            bash -c "pip install boto3 psycopg2-binary &&
            mlflow server
            --backend-store-uri postgresql://${POSTGRES_USER:-rakuten_user}:${POSTGRES_PASSWORD:-rakuten_pass}@postgres:5432/mlflow_db
            --default-artifact-root s3://mlflow-artifacts
            --host 0.0.0.0
            --port 5000"
        depends_on:
            postgres:
                condition: service_healthy
            minio-init:
                condition: service_completed_successfully
        healthcheck:
            test:
                [
                    "CMD-SHELL",
                    'python3 -c "import urllib.request; urllib.request.urlopen(''http://localhost:5000/health'')"',
                ]
            interval: 15s
            timeout: 5s
            retries: 10
            start_period: 30s
        networks:
            - rakuten_network

    # Airflow Database Initialization
    airflow-init:
        image: apache/airflow:2.8.0-python3.11
        container_name: rakuten_airflow_init
        environment:
            AIRFLOW__CORE__EXECUTOR: LocalExecutor
            AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://${POSTGRES_USER:-rakuten_user}:${POSTGRES_PASSWORD:-rakuten_pass}@postgres:5432/airflow_db
            AIRFLOW__CORE__FERNET_KEY: ${AIRFLOW_FERNET_KEY:-46BKJoQYlPPOexq0OhDZnIlNepKFf87WFwLbfzqDDho=}
            AIRFLOW__CORE__LOAD_EXAMPLES: "false"
            _AIRFLOW_DB_MIGRATE: "true"
            _AIRFLOW_WWW_USER_CREATE: "true"
            _AIRFLOW_WWW_USER_USERNAME: ${AIRFLOW_USER:-admin}
            _AIRFLOW_WWW_USER_PASSWORD: ${AIRFLOW_PASSWORD:-admin}
        volumes:
            - ./dags:/opt/airflow/dags
            - ./src:/opt/airflow/src
            - ./data:/opt/airflow/data
            - airflow_logs:/opt/airflow/logs
        entrypoint: /bin/bash
        command: >
            -c "airflow db migrate &&
                airflow users create --username $${_AIRFLOW_WWW_USER_USERNAME} --password $${_AIRFLOW_WWW_USER_PASSWORD} --firstname Admin --lastname User --role Admin --email admin@example.com || true"
        depends_on:
            postgres:
                condition: service_healthy
        networks:
            - rakuten_network

    # Airflow Webserver
    airflow-webserver:
        image: apache/airflow:2.8.0-python3.11
        container_name: rakuten_airflow_webserver
        environment:
            AIRFLOW__CORE__EXECUTOR: LocalExecutor
            AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://${POSTGRES_USER:-rakuten_user}:${POSTGRES_PASSWORD:-rakuten_pass}@postgres:5432/airflow_db
            AIRFLOW__CORE__FERNET_KEY: ${AIRFLOW_FERNET_KEY:-46BKJoQYlPPOexq0OhDZnIlNepKFf87WFwLbfzqDDho=}
            AIRFLOW__CORE__LOAD_EXAMPLES: "false"
            AIRFLOW__WEBSERVER__SECRET_KEY: ${AIRFLOW_SECRET_KEY:-supersecretkey}
            MLFLOW_TRACKING_URI: http://mlflow:5000

            # MinIO
            AWS_ACCESS_KEY_ID: ${MINIO_ROOT_USER:-minio_admin}
            AWS_SECRET_ACCESS_KEY: ${MINIO_ROOT_PASSWORD:-minio_password}
            # Connexion Airflow → MinIO (pour S3KeySensor)
            AIRFLOW_CONN_MINIO_S3: aws://${MINIO_ROOT_USER:-minio_admin}:${MINIO_ROOT_PASSWORD:-minio_password}@/?endpoint_url=http%3A%2F%2Fminio%3A9000&region_name=us-east-1

            POSTGRES_HOST: postgres
            POSTGRES_PORT: 5432
            POSTGRES_DB: ${POSTGRES_DB:-rakuten_db}
            POSTGRES_USER: ${POSTGRES_USER:-rakuten_user}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-rakuten_pass}
        volumes:
            - ./dags:/opt/airflow/dags
            - ./src:/opt/airflow/src
            - ./data:/opt/airflow/data
            - airflow_logs:/opt/airflow/logs
            - ./requirements.txt:/requirements.txt
        ports:
            - "8080:8080"
        command: >
            bash -c "pip install -r /requirements.txt &&
                     airflow webserver"
        depends_on:
            postgres:
                condition: service_healthy
            mlflow:
                condition: service_healthy
            minio-init:
                condition: service_completed_successfully
            airflow-init:
                condition: service_completed_successfully
        networks:
            - rakuten_network
        healthcheck:
            test:
                ["CMD-SHELL", "curl -f http://localhost:8080/health || exit 1"]
            interval: 30s
            timeout: 10s
            retries: 5

    # Airflow Scheduler
    airflow-scheduler:
        image: apache/airflow:2.8.0-python3.11
        container_name: rakuten_airflow_scheduler
        environment:
            AIRFLOW__CORE__EXECUTOR: LocalExecutor
            AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://${POSTGRES_USER:-rakuten_user}:${POSTGRES_PASSWORD:-rakuten_pass}@postgres:5432/airflow_db
            AIRFLOW__CORE__FERNET_KEY: ${AIRFLOW_FERNET_KEY:-46BKJoQYlPPOexq0OhDZnIlNepKFf87WFwLbfzqDDho=}
            AIRFLOW__CORE__LOAD_EXAMPLES: "false"
            MLFLOW_TRACKING_URI: http://mlflow:5000

            MLFLOW_S3_ENDPOINT_URL: http://minio:9000
            # MinIO / S3
            AWS_ACCESS_KEY_ID: ${MINIO_ROOT_USER:-minio_admin}
            AWS_SECRET_ACCESS_KEY: ${MINIO_ROOT_PASSWORD:-minio_password}
            # Connexion Airflow → MinIO (pour S3KeySensor)
            AIRFLOW_CONN_MINIO_S3: aws://${MINIO_ROOT_USER:-minio_admin}:${MINIO_ROOT_PASSWORD:-minio_password}@/?endpoint_url=http%3A%2F%2Fminio%3A9000&region_name=us-east-1

            POSTGRES_HOST: postgres
            POSTGRES_PORT: 5432
            POSTGRES_DB: ${POSTGRES_DB:-rakuten_db}
            POSTGRES_USER: ${POSTGRES_USER:-rakuten_user}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-rakuten_pass}
        volumes:
            - ./dags:/opt/airflow/dags
            - ./src:/opt/airflow/src
            - ./data:/opt/airflow/data
            - airflow_logs:/opt/airflow/logs
            - ./requirements.txt:/requirements.txt
        command: >
            bash -c "pip install -r /requirements.txt &&
                     airflow scheduler"
        depends_on:
            postgres:
                condition: service_healthy
            mlflow:
                condition: service_healthy
            minio-init:
                condition: service_completed_successfully
            airflow-init:
                condition: service_completed_successfully
        networks:
            - rakuten_network

networks:
    rakuten_network:
        driver: bridge

volumes:
    postgres_data:
    minio_data:
    mlflow_artifacts:
    airflow_logs:
