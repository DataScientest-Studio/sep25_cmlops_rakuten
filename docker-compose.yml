version: "3.8"

# Rakuten MLOps - Simplified Stack (No Airflow/Prefect)
# Core services: PostgreSQL, MinIO, MLflow, API, Monitoring

services:
    # ============================================================================
    # DATABASE
    # ============================================================================
    postgres:
        image: postgres:15-alpine
        container_name: rakuten_postgres
        environment:
            POSTGRES_USER: ${POSTGRES_USER:-rakuten_user}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-rakuten_pass}
            POSTGRES_DB: ${POSTGRES_DB:-rakuten_db}
        volumes:
            - postgres_data:/var/lib/postgresql/data
            - ./src/data/init-db.sh:/docker-entrypoint-initdb.d/01-init-db.sh
            - ./src/data/schema.sql:/docker-entrypoint-initdb.d/02-schema.sql
        ports:
            - "5432:5432"
        healthcheck:
            test:
                [
                    "CMD-SHELL",
                    "pg_isready -U ${POSTGRES_USER:-rakuten_user} -d ${POSTGRES_DB:-rakuten_db}",
                ]
            interval: 10s
            timeout: 5s
            retries: 5
        networks:
            - rakuten_network
        restart: unless-stopped

    # ============================================================================
    # OBJECT STORAGE (MinIO - S3 Compatible)
    # ============================================================================
    minio:
        image: minio/minio:RELEASE.2024-06-13T22-53-53Z
        container_name: rakuten_minio
        environment:
            MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minio_admin}
            MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minio_password}
        volumes:
            - minio_data:/data
        ports:
            - "9000:9000" # S3 API
            - "9001:9001" # Web Console
        command: server /data --console-address ":9001"
        healthcheck:
            test: ["CMD", "mc", "ready", "local"]
            interval: 10s
            timeout: 5s
            retries: 5
        networks:
            - rakuten_network
        restart: unless-stopped

    # MinIO Bucket Initialization
    minio-init:
        image: minio/mc:RELEASE.2024-06-12T14-34-03Z
        container_name: rakuten_minio_init
        depends_on:
            minio:
                condition: service_healthy
        entrypoint: >
            /bin/sh -c "
            mc alias set myminio http://minio:9000 $${MINIO_ROOT_USER:-minio_admin} $${MINIO_ROOT_PASSWORD:-minio_password};
            mc mb myminio/mlflow-artifacts --ignore-existing;
            echo 'MLflow bucket created successfully';
            exit 0;
            "
        environment:
            MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minio_admin}
            MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minio_password}
        networks:
            - rakuten_network

    # ============================================================================
    # MLFLOW TRACKING SERVER
    # ============================================================================
    mlflow:
        image: ghcr.io/mlflow/mlflow:v2.10.0
        container_name: rakuten_mlflow
        environment:
            MLFLOW_BACKEND_STORE_URI: postgresql://${POSTGRES_USER:-rakuten_user}:${POSTGRES_PASSWORD:-rakuten_pass}@postgres:5432/mlflow_db
            MLFLOW_S3_ENDPOINT_URL: http://minio:9000
            AWS_ACCESS_KEY_ID: ${MINIO_ROOT_USER:-minio_admin}
            AWS_SECRET_ACCESS_KEY: ${MINIO_ROOT_PASSWORD:-minio_password}
        ports:
            - "5000:5000"
        command: >
            bash -c "pip install boto3 psycopg2-binary &&
            mlflow server
            --backend-store-uri postgresql://${POSTGRES_USER:-rakuten_user}:${POSTGRES_PASSWORD:-rakuten_pass}@postgres:5432/mlflow_db
            --default-artifact-root s3://mlflow-artifacts
            --host 0.0.0.0
            --port 5000"
        depends_on:
            postgres:
                condition: service_healthy
            minio-init:
                condition: service_completed_successfully
        healthcheck:
            test:
                [
                    "CMD-SHELL",
                    'python3 -c "import urllib.request; urllib.request.urlopen(''http://localhost:5000/health'')"',
                ]
            interval: 15s
            timeout: 5s
            retries: 10
            start_period: 30s
        networks:
            - rakuten_network
        restart: unless-stopped

    # ============================================================================
    # FASTAPI MODEL SERVING
    # ============================================================================
    api:
        build:
            context: .
            dockerfile: src/serve/Dockerfile
        container_name: rakuten_api
        environment:
            MLFLOW_TRACKING_URI: http://mlflow:5000
            MLFLOW_S3_ENDPOINT_URL: http://minio:9000
            AWS_ACCESS_KEY_ID: ${MINIO_ROOT_USER:-minio_admin}
            AWS_SECRET_ACCESS_KEY: ${MINIO_ROOT_PASSWORD:-minio_password}
            MODEL_NAME: ${MODEL_NAME:-rakuten_classifier}
            MODEL_STAGE: ${MODEL_STAGE:-Production}
            MODEL_RELOAD_INTERVAL: ${MODEL_RELOAD_INTERVAL:-300}
            API_HOST: ${API_HOST:-0.0.0.0}
            API_PORT: ${API_PORT:-8000}
            INFERENCE_LOG_PATH: ${INFERENCE_LOG_PATH:-/app/data/monitoring/inference_log.csv}
            POSTGRES_HOST: postgres
            POSTGRES_PORT: 5432
            POSTGRES_DB: ${POSTGRES_DB:-rakuten_db}
            POSTGRES_USER: ${POSTGRES_USER:-rakuten_user}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-rakuten_pass}
        volumes:
            - ./data/monitoring:/app/data/monitoring
            - ./src:/app/src
        ports:
            - "8000:8000"
        depends_on:
            mlflow:
                condition: service_healthy
        healthcheck:
            test: ["CMD-SHELL", 'python -c "import urllib.request; urllib.request.urlopen(''http://localhost:8000/health'')"']
            interval: 30s
            timeout: 10s
            retries: 5
            start_period: 45s
        networks:
            - rakuten_network
        restart: unless-stopped

    # ============================================================================
    # MONITORING - PROMETHEUS
    # ============================================================================
    prometheus:
        image: prom/prometheus:v2.54.1
        container_name: rakuten_prometheus
        command:
            - "--config.file=/etc/prometheus/prometheus.yml"
            - "--storage.tsdb.path=/prometheus"
            - "--storage.tsdb.retention.time=${PROMETHEUS_RETENTION:-30d}"
        volumes:
            - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
            - prometheus_data:/prometheus
        ports:
            - "${PROMETHEUS_PORT:-9090}:9090"
        healthcheck:
            test: ["CMD", "wget", "--spider", "-q", "http://localhost:9090/-/healthy"]
            interval: 30s
            timeout: 10s
            retries: 3
        networks:
            - rakuten_network
        restart: unless-stopped

    # ============================================================================
    # MONITORING - GRAFANA
    # ============================================================================
    grafana:
        image: grafana/grafana:11.4.0
        container_name: rakuten_grafana
        environment:
            GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
            GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin}
            GF_SERVER_ROOT_URL: http://localhost:${GRAFANA_PORT:-3000}
            GF_USERS_ALLOW_SIGN_UP: false
            GF_AUTH_ANONYMOUS_ENABLED: true
            GF_AUTH_ANONYMOUS_ORG_ROLE: Viewer
            GF_PATHS_PROVISIONING: /etc/grafana/provisioning
        volumes:
            - ./grafana/provisioning:/etc/grafana/provisioning
            - grafana_data:/var/lib/grafana
        ports:
            - "${GRAFANA_PORT:-3000}:3000"
        depends_on:
            - prometheus
        healthcheck:
            test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/api/health"]
            interval: 30s
            timeout: 10s
            retries: 3
        networks:
            - rakuten_network
        restart: unless-stopped

networks:
    rakuten_network:
        driver: bridge

volumes:
    postgres_data:
    minio_data:
    prometheus_data:
    grafana_data:
